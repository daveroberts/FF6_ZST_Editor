<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FF6 ZST editor</title>
  <meta name="description" content="FF6 ZST Editor">
</head>
<body>
  <form action='#' onsubmit="return false;">
    <input type='file' id='fileinput' onchange="loadFile();" >
  </form>
  <button onclick="download();">Download</button>
  <h2>Cyan</h2>
  <div>Level: <input type="text" id="cyan_level" /></div>
  <div>Current HP: <input type="text" id="cyan_curhp" /></div>
  <div>Current HP2: <input type="text" id="cyan_curhp2" /></div>
  <div>Max HP: <input type="text" id="cyan_maxhp" /></div>
  <script>
    var data = null;
    const mappings = [
      {name: "cyan_level", offset: "2265", type: "number"},
      {name: "cyan_curhp", offset: "2266", type: "number"},
      {name: "cyan_curhp2", offset: "2267", type: "number"},
      {name: "cyan_maxhp", offset: "2268", type: "number"},
    ];
    mappings.forEach(function(mapping){
      var el = document.getElementById(mapping.name);
      el.addEventListener("change", function(){
        data[parseInt(mapping.offset, 16)] = el.value.toString(16);
        showResult("Debug");
      });
    });
    
    function loadFile() {
      var input = document.getElementById('fileinput');
      var file = input.files[0];
      var fr = new FileReader();
      fr.onload = fileLoaded;
      fr.readAsArrayBuffer(file);

      function fileLoaded() {
        var tmp = fr.result;
        console.log(typeof(tmp));
        console.log(tmp);
        data = new Uint8Array(tmp);
        mappings.forEach(function(mapping){
          var el = document.getElementById(mapping.name);
          el.value=data[parseInt(mapping.offset, 16)];
        });
        showResult("Binary");
      }
    }

    function showResult(label) {
      var markup = [];
      for (var n = 0; n < data.length; ++n) {
        markup.push(("00"+data[n].toString(16)).substr(-2));
      }
      bodyAppend("p", label + " (" + data.length + "):");
      bodyAppend("pre", markup.join(" "));
    }

    function bodyAppend(tagName, innerHTML) {
      var elm = document.createElement(tagName);
      elm.innerHTML = innerHTML;
      document.body.appendChild(elm);
    }
    
    function download(){
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      var blob = new Blob([data], {type: "application/octet-stream"}),
            url = window.URL.createObjectURL(blob);
      a.href = url;
      a.download = "copyIHope.txt";
      a.click();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>